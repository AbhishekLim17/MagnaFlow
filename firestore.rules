rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==========================================
    // HELPER FUNCTIONS
    // ==========================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    function isStaff() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'staff';
    }
    
    // Allow read-only access for cron trigger (token-protected at app level)
    function isCronTrigger() {
      return !isAuthenticated();
    }
    
    // Validate user data structure
    function isValidUserData() {
      return request.resource.data.keys().hasAll(['name', 'email', 'role']) &&
             request.resource.data.role in ['admin', 'staff'] &&
             request.resource.data.email is string &&
             request.resource.data.name is string;
    }
    
    // Validate task data structure
    function isValidTaskData() {
      return request.resource.data.keys().hasAll(['title', 'status', 'priority']) &&
             request.resource.data.status in ['pending', 'in-progress', 'completed', 'cancelled'] &&
             request.resource.data.priority in ['low', 'medium', 'high', 'critical'];
    }

    // ==========================================
    // USERS COLLECTION
    // ==========================================
    match /users/{userId} {
      // Users can read their own profile, cron can read for email reminders
      allow get: if isOwner(userId) || isCronTrigger();
      
      // Only admins can list all users, cron can list for email reminders
      allow list: if isAdmin() || isCronTrigger();
      
      // Users can update their own profile (limited fields only)
      // Cannot change role, status, or email
      allow update: if isOwner(userId) && 
                       !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'status', 'email', 'uid']);
      
      // Only admins can create new users with validation
      allow create: if isAdmin() && isValidUserData();
      
      // Only admins can delete users
      allow delete: if isAdmin();
    }

    // ==========================================
    // TASKS COLLECTION
    // ==========================================
    match /tasks/{taskId} {
      // Staff can read tasks assigned to them, cron can read for reminders
      allow get: if (isAuthenticated() && 
                    (isAdmin() || resource.data.assignedTo == request.auth.uid)) ||
                    isCronTrigger();
      
      // Admins can list all tasks, staff can list their assigned tasks, cron can list for reminders
      allow list: if isAuthenticated() || isCronTrigger();
      
      // Admins can create any task, staff can create tasks assigned to themselves
      allow create: if (isAdmin() || (isStaff() && request.resource.data.assignedTo == request.auth.uid)) && isValidTaskData();
      
      // Admins can update any task, staff can update their own tasks (status, description, etc.)
      allow update: if (isAdmin() || (isStaff() && resource.data.assignedTo == request.auth.uid)) && isValidTaskData();
      
      // Only admins can delete tasks
      allow delete: if isAdmin();
    }

    // ==========================================
    // COMPANIES COLLECTION
    // ==========================================
    match /companies/{companyId} {
      allow get, list: if isAuthenticated();
      allow create, update, delete: if isAdmin();
    }

    // ==========================================
    // DEPARTMENTS COLLECTION
    // ==========================================
    match /departments/{departmentId} {
      allow get, list: if isAuthenticated();
      allow create, update, delete: if isAdmin();
    }

    // ==========================================
    // DESIGNATIONS COLLECTION
    // ==========================================
    match /designations/{designationId} {
      allow get, list: if isAuthenticated();
      allow create, update, delete: if isAdmin();
    }

    // ==========================================
    // PERFORMANCE REPORTS COLLECTION
    // ==========================================
    match /performanceReports/{reportId} {
      // Staff can read their own reports
      allow get: if isAuthenticated() && 
                    (isAdmin() || resource.data.userId == request.auth.uid);
      
      // Only admins can list all reports
      allow list: if isAdmin();
      
      // Only admins can write reports
      allow create, update, delete: if isAdmin();
    }

    // ==========================================
    // REMINDER LOGS COLLECTION
    // NOTE: These rules are intentionally permissive for cron trigger
    // The cron endpoint itself is token-protected at application level
    // ==========================================
    match /reminder_logs/{logId} {
      // Allow read/write for cron trigger (protected by token at app level)
      // Cron needs READ to check if already sent today
      // Cron needs WRITE to save execution logs
      allow get, list: if true;
      allow create: if true;
      
      // Prevent updates and deletes for data integrity
      allow update, delete: if false;
    }

    // ==========================================
    // SYSTEM MONITORING COLLECTION
    // NOTE: These rules are intentionally permissive for cron trigger
    // The cron endpoint itself is token-protected at application level
    // ==========================================
    match /system_monitoring/{docId} {
      // Allow read/write for cron trigger email quota tracking
      allow get, list: if true;
      allow create, update: if true;
      
      // Prevent deletes for data integrity
      allow delete: if false;
    }

    // ==========================================
    // SUBTASKS COLLECTION
    // ==========================================
    match /subtasks/{subtaskId} {
      // Staff can read subtasks for tasks assigned to them
      // Admin can read all subtasks
      allow get: if isAuthenticated() && 
                    (isAdmin() || 
                     get(/databases/$(database)/documents/tasks/$(resource.data.taskId)).data.assignedTo == request.auth.uid);
      
      // Admins can list all subtasks, staff can list subtasks for their tasks
      allow list: if isAuthenticated();
      
      // Staff can create subtasks for their assigned tasks
      // Admin can create any subtasks
      allow create: if isAuthenticated() && 
                       (isAdmin() || 
                        get(/databases/$(database)/documents/tasks/$(request.resource.data.taskId)).data.assignedTo == request.auth.uid);
      
      // Staff can update subtasks for their assigned tasks
      // Admin can update any subtasks
      allow update: if isAuthenticated() && 
                       (isAdmin() || 
                        get(/databases/$(database)/documents/tasks/$(resource.data.taskId)).data.assignedTo == request.auth.uid);
      
      // Staff can delete subtasks for their assigned tasks
      // Admin can delete any subtasks
      allow delete: if isAuthenticated() && 
                       (isAdmin() || 
                        get(/databases/$(database)/documents/tasks/$(resource.data.taskId)).data.assignedTo == request.auth.uid);
    }

    // ==========================================
    // EMAIL LOGS COLLECTION
    // ==========================================
    match /email_logs/{logId} {
      // Any authenticated user can create email logs
      allow create: if isAuthenticated();
      
      // Only admins can read email logs
      allow get, list: if isAdmin();
      
      // Prevent updates and deletes for audit trail integrity
      allow update, delete: if false;
    }

    // ==========================================
    // TASK COMMENTS COLLECTION
    // ==========================================
    match /task_comments/{commentId} {
      // Validate comment data structure
      function isValidComment() {
        return request.resource.data.keys().hasAll(['taskId', 'userId', 'userName', 'userEmail', 'text']) &&
               request.resource.data.text is string &&
               request.resource.data.text.size() > 0 &&
               request.resource.data.text.size() <= 5000 &&
               request.resource.data.userId == request.auth.uid;
      }

      // Check if user is comment author
      function isCommentAuthor() {
        return resource.data.userId == request.auth.uid;
      }

      // All authenticated users can read comments
      allow get, list: if isAuthenticated();
      
      // Authenticated users can create comments with valid data
      allow create: if isAuthenticated() && isValidComment();
      
      // Author or admin can update comments (text and mentions only)
      allow update: if isAuthenticated() && 
                       (isCommentAuthor() || isAdmin()) &&
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['text', 'mentions', 'updatedAt', 'edited']);
      
      // Author or admin can soft delete comments
      allow delete: if isAuthenticated() && (isCommentAuthor() || isAdmin());
    }

    // ==========================================
    // COMMENT NOTIFICATIONS COLLECTION
    // ==========================================
    match /comment_notifications/{notificationId} {
      // Validate notification data
      function isValidNotification() {
        return request.resource.data.keys().hasAll(['userId', 'commentId', 'taskId', 'mentionedBy', 'mentionedByName', 'read']);
      }

      // Check if user owns the notification
      function isNotificationOwner() {
        return resource.data.userId == request.auth.uid;
      }

      // Users can only read their own notifications
      allow get, list: if isAuthenticated() && isNotificationOwner();
      
      // System can create notifications (any authenticated user can trigger)
      allow create: if isAuthenticated() && isValidNotification();
      
      // Users can only update their own notifications (mark as read)
      allow update: if isAuthenticated() && 
                       isNotificationOwner() &&
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read']);
      
      // Users can delete their own notifications, admins can delete any
      allow delete: if isAuthenticated() && (isNotificationOwner() || isAdmin());
    }
  }
}